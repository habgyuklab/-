<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes">
    <title>í•©ê²©ë© í¼í™íŠ¸ ê´€ì œ ì‹œìŠ¤í…œ (v23 10ë¶„ë‹¨ìœ„)</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <style>
        :root {
            /* íŒŒìŠ¤í…” í†¤ ì»¬ëŸ¬ íŒ”ë ˆíŠ¸ */
            --seat-red: #ff8787;       /* ë¶€ë“œëŸ¬ìš´ ë¹¨ê°• */
            --seat-green: #69db7c;     /* ë¶€ë“œëŸ¬ìš´ ì´ˆë¡ */
            --seat-black: #343a40;     /* ë¶€ë“œëŸ¬ìš´ ê²€ì • */
            --seat-gray: #adb5bd;      /* íšŒìƒ‰ */
            --seat-exempt: #f1f3f5;    /* ë©´ì œ ë°°ê²½ */
            --seat-exempt-text: #868e96;
            
            --bg-color: #f0f5f9;       /* ì „ì²´ ë°°ê²½ (ì•„ì£¼ ì—°í•œ í•˜ëŠ˜ìƒ‰) */
            --sidebar-width: 400px;
            
            --table-border: #bac8ff;   /* í…Œì´ë¸” ì„  (íŒŒìŠ¤í…” ë¸”ë£¨) */
            --header-bg: #edf2ff;      /* í—¤ë” ë°°ê²½ */
            --btn-primary: #748ffc;    /* ì£¼ìš” ë²„íŠ¼ */
        }

        body {
            font-family: 'Pretendard', 'Malgun Gothic', sans-serif;
            background-color: var(--bg-color);
            margin: 0; padding: 0; min-height: 100vh;
            display: flex; flex-direction: column; user-select: none;
        }

        /* ì¸ì‡„ ì„¤ì • ê°•ì œ (ìƒ‰ìƒ ìœ ì§€) */
        @media print {
            body { 
                -webkit-print-color-adjust: exact !important;
                print-color-adjust: exact !important;
            }
            body > * { visibility: hidden; } 
            #schedule-modal, #schedule-modal * { visibility: visible; } 
            #schedule-modal { 
                position: absolute; left: 0; top: 0; width: 100%; height: auto; 
                overflow: visible; padding: 0 !important; box-shadow: none !important; 
                background: white !important;
            }
            /* ì¸ì‡„ ì‹œ ì…ë ¥ì°½ ë°°ê²½ ì œê±°í•˜ê³  ê¹”ë”í•˜ê²Œ */
            .info-grid { border: none !important; background: none !important; padding: 0 !important; margin-bottom: 20px !important; }
            .info-group input { border: none !important; border-bottom: 1px solid #000 !important; border-radius: 0 !important; padding-left: 0 !important; }
            
            /* ë¸”ë™ íƒ€ì„ ê°•ì œ ì¶œë ¥ */
            .break-row, .break-row td { background-color: #343a40 !important; color: white !important; -webkit-print-color-adjust: exact !important; }
            
            /* ë²„íŠ¼ ìˆ¨ê¸°ê¸° */
            .modal-footer, .preset-area, .btn-mini-reset, .btn-row-reset { display: none !important; }
            
            /* ì¸ì‡„ ì‹œ í…Œì´ë¸” í—¤ë” ì¡°ì • */
            .schedule-table th { position: static !important; }
        }

        #start-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(40, 50, 60, 0.9); z-index: 9999;
            display: flex; justify-content: center; align-items: center; flex-direction: column;
            color: white; cursor: pointer; text-align: center; backdrop-filter: blur(5px);
        }
        #start-overlay h1 { font-size: 3rem; margin-bottom: 20px; text-shadow: 0 2px 10px rgba(0,0,0,0.3); }
        #start-overlay p { font-size: 1.5rem; animation: pulse 1.5s infinite; color: #74c0fc; font-weight: bold; }

        header {
            background: white; padding: 10px 20px; border-bottom: 2px solid #e9ecef;
            display: flex; justify-content: space-between; align-items: center; height: 70px; box-sizing: border-box;
            box-shadow: 0 2px 5px rgba(0,0,0,0.02);
        }
        .header-logo img { height: 50px; }
        .header-clock { font-size: 1.4rem; font-weight: 800; color: #495057; background: #e7f5ff; padding: 8px 25px; border-radius: 30px; color: #1c7ed6; }

        /* ë©”ì¸ ë ˆì´ì•„ì›ƒ */
        .main-wrapper { display: flex; flex: 1; height: calc(100vh - 70px); overflow: hidden; }
        
        .seat-area-container {
            flex: 1; position: relative; overflow: hidden; background-color: #e9ecef;
            cursor: grab; touch-action: none;
        }
        .seat-area-container:active { cursor: grabbing; }

        .seat-area { 
            padding: 60px; display: flex; flex-direction: column; align-items: center; 
            transform-origin: top left; transition: transform 0.1s ease-out; 
            min-height: 100%; background-color: var(--bg-color); width: fit-content; margin: 0 auto; 
        }

        .sidebar { 
            width: var(--sidebar-width); background: white; border-left: 1px solid #dee2e6; 
            display: flex; flex-direction: column; box-shadow: -5px 0 15px rgba(0,0,0,0.03); z-index: 200; 
        }
        .sidebar-header { padding: 18px; background: #495057; color: white; font-weight: bold; text-align: center; font-size: 1.1rem; letter-spacing: 1px; }
        .sidebar-content { flex: 1; overflow-y: auto; padding: 15px; background-color: #f8f9fa; }

        /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
        .status-table { width: 100%; border-collapse: separate; border-spacing: 0 5px; font-size: 13px; }
        .status-table th { background: transparent; padding: 8px; color: #868e96; font-weight: 600; text-align: center; }
        .status-table td { padding: 12px 8px; background: white; border: 1px solid #e9ecef; text-align: center; vertical-align: middle; box-shadow: 0 1px 3px rgba(0,0,0,0.05); }
        .status-table tr td:first-child { border-top-left-radius: 8px; border-bottom-left-radius: 8px; font-weight: bold; color: #333; }
        .status-table tr td:last-child { border-top-right-radius: 8px; border-bottom-right-radius: 8px; }

        .badge-late { background: var(--seat-red); color: white; padding: 4px 8px; border-radius: 12px; font-weight: bold; font-size: 11px; display: inline-block; box-shadow: 0 2px 4px rgba(255, 107, 107, 0.3); }
        .badge-penalty-text { color: #e03131; font-weight: 900; font-size: 14px; animation: pulse 1s infinite; display: inline-block; margin-right: 5px; }

        /* ì¢Œì„ ìŠ¤íƒ€ì¼ */
        .grid-container { display: grid; gap: 8px; justify-content: center; margin-bottom: 40px; padding: 20px; background-color: white; border-radius: 20px; box-shadow: 0 5px 15px rgba(0,0,0,0.05); }
        #premium-grid { grid-template-columns: repeat(3, 100px); grid-template-rows: repeat(5, 70px); }
        #study-grid { grid-template-columns: repeat(10, 80px); grid-template-rows: repeat(16, 60px); }

        .seat {
            background-color: var(--seat-red); color: white; display: flex; flex-direction: column;
            justify-content: center; align-items: center; border-radius: 12px; font-weight: bold; font-size: 14px;
            box-shadow: 0 3px 0 rgba(0,0,0,0.1); cursor: pointer; transition: transform 0.1s, box-shadow 0.1s; position: relative;
            text-shadow: 0 1px 2px rgba(0,0,0,0.1);
        }
        .seat:hover { transform: translateY(-2px); box-shadow: 0 5px 0 rgba(0,0,0,0.1); z-index: 10; }
        .seat:active { transform: translateY(1px); box-shadow: 0 1px 0 rgba(0,0,0,0.1); }
        
        .seat.green { background-color: var(--seat-green); }
        .seat.black { background-color: var(--seat-black); color: #adb5bd; box-shadow: none; cursor: not-allowed; }
        .seat.gray-x { background-color: var(--seat-gray); color: #f1f3f5; box-shadow: none; }
        .seat.exempt { background-color: white; color: #ced4da; border: 2px dashed #dee2e6; box-shadow: none; }
        
        .time-badge { font-size: 10px; background: rgba(0,0,0,0.2); padding: 2px 6px; border-radius: 10px; margin-top: 3px; font-weight: normal; }
        .seat.flashing { animation: seat-flash 0.6s infinite ease-in-out !important; border: 2px solid #e03131 !important; z-index: 20; }
        @keyframes seat-flash {
            0% { background-color: var(--seat-red); transform: scale(1); }
            50% { background-color: #ffc9c9; transform: scale(1.05); box-shadow: 0 0 15px rgba(255, 107, 107, 0.6); }
            100% { background-color: var(--seat-red); transform: scale(1); }
        }

        /* ì»¨íŠ¸ë¡¤ ë²„íŠ¼ */
        .controls { padding: 20px; text-align: center; display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-top: 30px;}
        .btn-ctrl { padding: 12px 24px; font-size: 16px; font-weight: bold; cursor: pointer; border-radius: 30px; border: none; color: white; box-shadow: 0 4px 10px rgba(0,0,0,0.1); transition: all 0.2s; }
        .btn-ctrl:hover { transform: translateY(-2px); box-shadow: 0 6px 15px rgba(0,0,0,0.15); }
        .reset-btn { background-color: var(--seat-green); }
        .backup-btn { background-color: #4dabf7; }
        .restore-btn { background-color: #faa2c1; }

        /* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ */
        #modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.6); backdrop-filter: blur(3px); z-index: 2999; }
        #schedule-modal { 
            display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: white; padding: 35px; border-radius: 25px; width: 95%; max-width: 1250px; max-height: 95vh; overflow-y: auto; z-index: 3000; 
            box-shadow: 0 20px 50px rgba(0,0,0,0.2); border: 1px solid #e9ecef;
        }

        /* ì…ë ¥ì°½ ê°€ë¡œ ì™€ì´ë“œ ë°°ì¹˜ ë””ìì¸ */
        .info-grid {
            display: flex;
            flex-direction: column; /* ì„¸ë¡œë¡œ í•œ ì¤„ì”© */
            gap: 12px; /* ê°„ê²© ì¡°ì • */
            margin-bottom: 25px;
            padding: 25px;
            background-color: #f8f9fa;
            border-radius: 16px;
            border: 1px solid #e9ecef;
        }
        .info-group {
            display: flex;
            align-items: center;
            width: 100%;
        }
        .info-group label {
            width: 140px; /* ë¼ë²¨ ë„ˆë¹„ ê³ ì • */
            font-weight: 700;
            color: #495057;
            font-size: 15px;
            flex-shrink: 0;
            text-align: left;
            padding-left: 10px;
        }
        .info-group input {
            flex: 1; /* ë‚¨ì€ ê°€ë¡œ ê³µê°„ ëª¨ë‘ ì°¨ì§€ */
            padding: 12px 15px;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            font-size: 15px;
            transition: all 0.2s;
            background-color: white;
        }
        .info-group input:focus {
            outline: none;
            border-color: var(--btn-primary);
            box-shadow: 0 0 0 3px rgba(116, 143, 252, 0.1);
        }

        /* ì‹œê°„í‘œ í…Œì´ë¸” */
        .schedule-table { width: 100%; border-collapse: collapse; text-align: center; font-size: 13px; margin-bottom: 20px; border-style: hidden; }
        .schedule-table th, .schedule-table td { 
            border: 2px solid var(--table-border);
            padding: 6px; vertical-align: top; 
        }
        .schedule-table th { background: var(--header-bg); color: #495057; font-weight: 800; position: sticky; top: 0; z-index: 10; }
        .schedule-table th:first-child, .schedule-table td:first-child { 
            width: 130px; min-width: 130px; background-color: #dbe4ff; color: #364fc7; font-weight: bold; vertical-align: middle; font-size: 14px; border-right: 3px solid #91a7ff;
        }
        
        /* ì ì‹¬/ì €ë… ë¸”ë™ íƒ€ì„ */
        .break-row, .break-row td {
            background-color: #343a40 !important;
            color: white !important;
            border: 1px solid #343a40 !important;
            pointer-events: none;
            height: 35px;
        }
        .break-label { font-size: 14px; font-weight: bold; letter-spacing: 1px; }
        .break-sub { font-size: 11px; color: #ced4da; font-weight: normal; margin-left: 10px; }

        .schedule-table input[type="time"] { 
            width: 100%; border: 1px solid #dee2e6; padding: 5px; text-align: center; border-radius: 6px;
            cursor: pointer; margin-bottom: 4px; font-family: inherit; font-weight: bold;
        }
        .schedule-table input.memo-input { 
            width: 100%; border: none; border-bottom: 2px dotted #dee2e6; padding: 3px; 
            text-align: center; font-size: 12px; color: #495057; background: transparent; margin-bottom: 5px;
        }
        
        .btn-toggle-exempt { 
            display: block; width: 100%; padding: 4px; font-size: 11px; cursor: pointer; border-radius: 6px; 
            border: 1px solid #dee2e6; background-color: white; color: #868e96; transition: all 0.1s;
        }
        .btn-toggle-exempt.active { background-color: #fa5252; color: white; border-color: #fa5252; font-weight: bold; }
        
        .btn-mini-reset { margin-top: 4px; padding: 3px 8px; font-size: 11px; background-color: #e9ecef; border: none; border-radius: 12px; cursor: pointer; }
        .btn-row-reset { width: 100%; height: 100%; background: transparent; border: none; cursor: pointer; color: #e64980; font-weight: bold; font-size: 12px; }

        /* ê¸°íƒ€ UI */
        .zoom-controls { position: absolute; top: 90px; left: 20px; z-index: 1000; display: flex; flex-direction: column; gap: 8px; }
        .btn-zoom { width: 45px; height: 45px; background: white; color: #333; border: 2px solid #dee2e6; border-radius: 12px; font-size: 24px; font-weight: bold; cursor: pointer; }
        
        .action-btn { border: none; padding: 4px 8px; border-radius: 4px; font-size: 11px; font-weight: bold; cursor: pointer; margin: 1px; color: white; }
        .btn-attend { background-color: #51cf66; } .btn-penalty { background-color: #ff6b6b; }
        .btn-check { background-color: #adb5bd; } .btn-check.done { background-color: #339af0; }
        
        .preset-area { display: flex; gap: 10px; }
        .btn-preset { padding: 8px 16px; font-size: 13px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; color: white; box-shadow: 0 2px 4px rgba(0,0,0,0.1); }
        .btn-high { background-color: #845ef7; } .btn-nsu { background-color: #22b8cf; } 
        .btn-reset-all { background-color: #ff8787; } .btn-all-exempt { background-color: #fd7e14; }
        
        .modal-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 25px; border-top: 2px solid #f1f3f5; padding-top: 20px; }
        .btn { padding: 12px 25px; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; font-size: 14px; }
        .btn-save { background: #339af0; color: white; } .btn-cancel { background: #e9ecef; color: #495057; }
        .btn-print { background: #495057; color: white; margin-right: 10px; } .btn-img { background: #20c997; color: white; margin-right: 10px; }

        #file-input { display: none; }
        .context-menu { display: none; position: absolute; background: white; border: 1px solid #dee2e6; box-shadow: 0 5px 15px rgba(0,0,0,0.1); border-radius: 8px; z-index: 2000; width: 180px; overflow: hidden; }
        .context-menu li { padding: 12px 15px; cursor: pointer; border-bottom: 1px solid #f1f3f5; list-style: none; font-size: 14px; color: #495057; }
        .context-menu li:hover { background-color: #f1f3f5; color: #339af0; }

        .input-basic { background-color: #d3f9d8 !important; border: 1px solid #b2f2bb !important; color: #2b8a3e;}
        .input-custom { background-color: #fff3bf !important; border: 1px solid #ffe066 !important; color: #e67700;}
        .cell-red { background-color: #ffebee !important; }
        .cell-green { background-color: #d3f9d8 !important; }
        .cell-green-text { background-color: #fff3bf !important; font-weight: bold; color: #e67700 !important; }
    </style>
</head>
<body>
    
    <div id="start-overlay" onclick="startSystem()">
        <h1>ğŸ–±ï¸ í™”ë©´ì„ í´ë¦­í•˜ì„¸ìš”!</h1>
        <p>í•©ê²©ë© ê´€ì œ ì‹œìŠ¤í…œ ì‹œì‘í•˜ê¸°</p>
    </div>

    <header>
        <div class="header-logo">
            <img src="logo.png" alt="í•©ê²©LAB ë¼ì´ë¸ŒëŸ¬ë¦¬" onerror="this.style.display='none'; this.parentElement.innerText='í•©ê²©LAB ë¼ì´ë¸ŒëŸ¬ë¦¬';">
        </div>
        <div class="header-clock" id="current-clock">00:00:00 (ì›”)</div>
    </header>

    <div class="zoom-controls">
        <button class="btn-zoom" onclick="zoomIn()">+</button>
        <button class="btn-zoom" onclick="zoomOut()">-</button>
    </div>

    <div class="main-wrapper">
        <div class="seat-area-container" id="seatContainer">
            <div class="seat-area" id="seatArea">
                <h2 style="color:#495057;">í”„ë¦¬ë¯¸ì—„ ì¡´</h2><div id="premium-grid" class="grid-container"></div>
                <h2 style="color:#495057;">ìŠ¤í„°ë”” ì¡´</h2><div id="study-grid" class="grid-container"></div>
                <div class="controls">
                    <button class="btn-ctrl reset-btn" onclick="resetGreenSeats()">ğŸ”„ í‡´ì‹¤ ì²˜ë¦¬</button>
                    <button class="btn-ctrl backup-btn" onclick="downloadBackup()">ğŸ’¾ ë°ì´í„° ë°±ì—…</button>
                    <button class="btn-ctrl restore-btn" onclick="triggerRestore()">ğŸ“‚ ë°±ì—… ë¶ˆëŸ¬ì˜¤ê¸°</button>
                    <input type="file" id="file-input" accept="*/*" onchange="loadBackup(this)">
                </div>
            </div>
        </div>
        <div class="sidebar">
            <div class="sidebar-header">ğŸš¨ ì‹¤ì‹œê°„ ì§€ê° ê´€ì œ</div>
            <div class="sidebar-content">
                <table class="status-table">
                    <thead><tr><th style="width: 25%">ì´ë¦„</th><th style="width: 25%">ì¶œì„í˜„í™©</th><th style="width: 50%">ì²˜ë¦¬í˜„í™©</th></tr></thead>
                    <tbody id="status-tbody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <audio id="alarm-sound" src="í•©ê²©ë© ì¢…ì†Œë¦¬.MP3" loop></audio>

    <ul id="seat-context-menu" class="context-menu">
        <li onclick="seatMenuAction('schedule')">ğŸ“‹ ê°œì¸ ì‹œê°„í‘œ ë° ì •ë³´ ì„¤ì •</li>
        <li onclick="seatMenuAction('editName')">âœï¸ ì´ë¦„ë§Œ ë¹ ë¥´ê²Œ ë³€ê²½</li>
        <li onclick="seatMenuAction('toggleBlack')">ğŸ”’ ê³ ì •ì„(ê²€ì •) ì„¤ì •/í•´ì œ</li>
    </ul>

    <div id="modal-overlay"></div>
    <div id="schedule-modal">
        <div class="modal-header">
            <h2>í•©ê²©ë© ê°œì¸ì‹œê°„í‘œ</h2>
            <div class="preset-area">
                <button class="btn-preset btn-high" onclick="applyPresetHighSchool()">ğŸ« ê³ ë“±ë°˜</button>
                <button class="btn-preset btn-nsu" onclick="applyPresetNSu()">ğŸ“š Nìˆ˜/ì„±ì¸ë°˜</button>
                <button class="btn-preset btn-all-exempt" onclick="setAllExempt()">ğŸš« ì „ì²´ ì…ì‹¤ì•ˆí•¨</button>
                <button class="btn-preset btn-reset-all" onclick="resetAllSchedule()">ğŸ”„ ì „ì²´ ì´ˆê¸°í™”</button>
            </div>
        </div>

        <div class="info-grid">
            <div class="info-group"><label>ì´ë¦„</label><input type="text" id="info-name" placeholder="ì´ë¦„ ì…ë ¥"></div>
            <div class="info-group"><label>ì´ìš©ê¸°ê°„</label><input type="text" id="info-period" placeholder="ì˜ˆ: ~12/31"></div>
            <div class="info-group"><label>ì¢Œì„ ë²ˆí˜¸</label><input type="text" id="info-seat" placeholder="ë²ˆí˜¸ ì…ë ¥"></div>
            <div class="info-group"><label>ì‚¬ë¬¼í•¨ ë²ˆí˜¸</label><input type="text" id="info-locker" placeholder="ë²ˆí˜¸ ì…ë ¥"></div>
            <div class="info-group"><label>í°ë³´ê´€í•¨ ë²ˆí˜¸</label><input type="text" id="info-phone" placeholder="ë²ˆí˜¸ ì…ë ¥"></div>
        </div>

        <p style="text-align:center; font-size:13px; color:#868e96; margin-top:0;">
            ë¹ˆì¹¸: ê¸°ë³¸ì‹œê°„ ì ìš© | <b>[ë©”ëª¨]</b>ëŠ” ì¸ì‡„ ì‹œ ê´„í˜¸ ì•ˆì— í‘œì‹œ | <b>[ì „ì²´ ì´ˆê¸°í™”]</b>ë¡œ í–‰ ë‹¨ìœ„ ì‚­ì œ ê°€ëŠ¥
        </p>
        <table class="schedule-table">
            <thead>
                <tr>
                    <th>êµì‹œ</th>
                    <th>ì¼<br><button class="btn-mini-reset" onclick="resetDaySchedule(0)">ì´ˆê¸°í™”</button></th>
                    <th>ì›”<br><button class="btn-mini-reset" onclick="resetDaySchedule(1)">ì´ˆê¸°í™”</button></th>
                    <th>í™”<br><button class="btn-mini-reset" onclick="resetDaySchedule(2)">ì´ˆê¸°í™”</button></th>
                    <th>ìˆ˜<br><button class="btn-mini-reset" onclick="resetDaySchedule(3)">ì´ˆê¸°í™”</button></th>
                    <th>ëª©<br><button class="btn-mini-reset" onclick="resetDaySchedule(4)">ì´ˆê¸°í™”</button></th>
                    <th>ê¸ˆ<br><button class="btn-mini-reset" onclick="resetDaySchedule(5)">ì´ˆê¸°í™”</button></th>
                    <th>í† <br><button class="btn-mini-reset" onclick="resetDaySchedule(6)">ì´ˆê¸°í™”</button></th>
                    <th>ì „ì²´<br>ì´ˆê¸°í™”</th>
                </tr>
            </thead>
            <tbody id="schedule-tbody"></tbody>
        </table>

        <div class="modal-footer">
            <img src="logo.png" alt="í•©ê²©LAB" class="modal-logo" onerror="this.style.display='none'">
            <div class="modal-actions">
                <button class="btn btn-img" onclick="saveAsImage()">ğŸ“· ì´ë¯¸ì§€ ì €ì¥</button>
                <button class="btn btn-print" onclick="printSchedule()">ğŸ–¨ï¸ ì¸ì‡„</button>
                <button class="btn btn-save" onclick="saveSchedule()">ì €ì¥ ë° ë‹«ê¸°</button>
                <button class="btn btn-cancel" onclick="closeModal()">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

    <script>
        const DAYS = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];
        const PERIODS = [
            { name: "1êµì‹œ", start: "08:00", end: "09:10" }, 
            { name: "2êµì‹œ", start: "09:20", end: "10:40" },
            { name: "3êµì‹œ", start: "10:50", end: "12:00" }, 
            { name: "4êµì‹œ", start: "13:10", end: "14:40" },
            { name: "5êµì‹œ", start: "14:50", end: "16:20" }, 
            { name: "6êµì‹œ", start: "16:30", end: "18:00" },
            { name: "7êµì‹œ", start: "19:10", end: "20:40" }, 
            { name: "8êµì‹œ", start: "20:50", end: "22:20" },
            { name: "9êµì‹œ", start: "22:30", end: "24:00" }
        ];

        let seatsData = {}; let selectedSeatId = null; let lastResetTime = ""; 
        let isAlarmPlaying = false;
        let scale = 1;
        const container = document.getElementById('seatContainer');
        const content = document.getElementById('seatArea');
        let isDragging = false;
        let startX, startY, scrollLeft, scrollTop;

        window.onload = function() {
            loadData(); renderSeats(); 
            document.addEventListener('click', () => { document.getElementById('seat-context-menu').style.display = 'none'; });
            
            container.addEventListener('mousedown', (e) => {
                isDragging = true; container.style.cursor = 'grabbing';
                startX = e.pageX - container.offsetLeft; startY = e.pageY - container.offsetTop;
                scrollLeft = container.scrollLeft; scrollTop = container.scrollTop;
            });
            container.addEventListener('mouseleave', () => { isDragging = false; container.style.cursor = 'grab'; });
            container.addEventListener('mouseup', () => { isDragging = false; container.style.cursor = 'grab'; });
            container.addEventListener('mousemove', (e) => {
                if(!isDragging) return; e.preventDefault();
                const x = e.pageX - container.offsetLeft; const y = e.pageY - container.offsetTop;
                const walkX = (x - startX) * 1.5; const walkY = (y - startY) * 1.5;
                container.scrollLeft = scrollLeft - walkX; container.scrollTop = scrollTop - walkY;
            });
            container.addEventListener('touchstart', (e) => {
                isDragging = true; startX = e.touches[0].pageX - container.offsetLeft;
                startY = e.touches[0].pageY - container.offsetTop; scrollLeft = container.scrollLeft; scrollTop = container.scrollTop;
            });
            container.addEventListener('touchmove', (e) => {
                if(!isDragging) return;
                const x = e.touches[0].pageX - container.offsetLeft; const y = e.touches[0].pageY - container.offsetTop;
                const walkX = (x - startX) * 1.5; const walkY = (y - startY) * 1.5;
                container.scrollLeft = scrollLeft - walkX; container.scrollTop = scrollTop - walkY;
            });
            container.addEventListener('touchend', () => { isDragging = false; });
        };
        
        function zoomIn() { if (scale < 2.0) { scale += 0.1; applyZoom(); } }
        function zoomOut() { if (scale > 0.5) { scale -= 0.1; applyZoom(); } }
        function applyZoom() { content.style.transform = `scale(${scale})`; }

        function startSystem() {
            document.getElementById('start-overlay').style.display = 'none';
            checkPeriodOnLoad(); setInterval(gameLoop, 1000); document.body.addEventListener('click', stopAlarm);
        }

        function loadData() {
            const v14 = localStorage.getItem('studyRoom_v14_final');
            if (v14) { seatsData = JSON.parse(v14); } 
            else { 
                const v13 = localStorage.getItem('studyRoom_v13_memo');
                if (v13) { seatsData = JSON.parse(v13); migrateData(); saveData(); }
                else {
                    const v8 = localStorage.getItem('studyRoom_v8_final');
                    if (v8) { seatsData = JSON.parse(v8); migrateData(); saveData(); }
                    else { initData('P', 15); initData('S', 160); }
                }
            }
        }
        function saveData() { localStorage.setItem('studyRoom_v14_final', JSON.stringify(seatsData)); }
        function migrateData() {
            for (const id in seatsData) {
                if (!seatsData[id].memoGrid) seatsData[id].memoGrid = {}; 
                if (!seatsData[id].info) seatsData[id].info = { period: '', locker: '', phone: '' };
            }
        }
        function initData(prefix, count) {
            for (let i = 1; i <= count; i++) {
                const id = `${prefix}-${i}`;
                if (!seatsData[id]) { 
                    seatsData[id] = { 
                        id: id, name: 'X', state: 0, 
                        scheduleGrid: {}, memoGrid: {}, scheduleV3: {}, penaltyInfo: null, exemptGrid: {},
                        info: { period: '', locker: '', phone: '' } 
                    }; 
                }
            }
        }

        function checkPeriodOnLoad() {
            const now = new Date();
            const currentHM = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
            const todayIdx = now.getDay();
            let currentPeriodIdx = -1;
            PERIODS.forEach((p, idx) => { if (currentHM >= p.start) currentPeriodIdx = idx; });
            const storedLastPeriod = localStorage.getItem('last_active_period');
            if (currentPeriodIdx !== -1 && String(currentPeriodIdx) !== storedLastPeriod) {
                checkAndResetSeats(PERIODS[currentPeriodIdx].start, todayIdx, true); 
                localStorage.setItem('last_active_period', currentPeriodIdx);
                playAlarm();
            } else { updateSidebarList(); }
        }

        function playAlarm() {
            const audio = document.getElementById('alarm-sound');
            if (!isAlarmPlaying) { audio.currentTime = 0; audio.play().then(() => { isAlarmPlaying = true; }).catch(e => console.log(e)); }
        }
        function stopAlarm() {
            const audio = document.getElementById('alarm-sound');
            if (isAlarmPlaying) { audio.pause(); isAlarmPlaying = false; }
        }

        function renderSeats() { drawGrid('premium-grid', 'P', 15); drawGrid('study-grid', 'S', 160); refreshVisuals(); }
        function drawGrid(gridId, prefix, count) {
            const container = document.getElementById(gridId); container.innerHTML = '';
            for (let i = 1; i <= count; i++) {
                const id = `${prefix}-${i}`; const div = document.createElement('div');
                div.className = 'seat'; div.id = id;
                div.onclick = () => toggleSeat(id); div.oncontextmenu = (e) => showSeatMenu(e, id);
                div.innerHTML = `<span class="seat-name"></span><span class="time-badge"></span>`;
                container.appendChild(div);
            }
        }
        function refreshVisuals() {
            const now = new Date(); const today = now.getDay();
            for (const id in seatsData) {
                const data = seatsData[id]; const el = document.getElementById(id);
                if (!el) continue;
                el.querySelector('.seat-name').textContent = data.name;
                const todayTimes = (data.scheduleV3 && data.scheduleV3[today]) ? data.scheduleV3[today] : [];
                const badge = el.querySelector('.time-badge');
                const configuredCount = todayTimes.length > 0 ? todayTimes.length : 0;
                badge.style.display = configuredCount > 0 ? 'block' : 'none';
                badge.textContent = configuredCount > 0 ? `${configuredCount}êµì‹œ ì„¤ì •` : '';
                el.classList.remove('green', 'black', 'gray-x', 'exempt');
                if (data.state === 3) el.classList.add('black'); 
                else if (data.state === 1) el.classList.add('green'); 
                else if (data.state === 4) el.classList.add('exempt'); 
                else if (data.name === 'X') el.classList.add('gray-x'); 
            }
        }
        function toggleSeat(id) {
            const data = seatsData[id]; if (data.state === 3) return;
            if (data.state === 1) { data.state = 0; } else { data.state = 1; data.penaltyInfo = null; }
            saveData(); refreshVisuals(); updateSidebarList();
        }
        function gameLoop() {
            const now = new Date();
            const currentHM = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
            const todayIdx = now.getDay();
            document.getElementById('current-clock').textContent = `${now.toLocaleTimeString('ko-KR', { hour12: false })} (${DAYS[todayIdx]})`;
            if (currentHM !== lastResetTime) {
                lastResetTime = currentHM;
                PERIODS.forEach((p, idx) => { if (p.start === currentHM) localStorage.setItem('last_active_period', idx); });
                checkAndResetSeats(currentHM, todayIdx, false);
            }
            updateSidebarList();
        }
        function checkAndResetSeats(time, dayIdx, forceReset) {
            let changed = false; let triggerAlarm = false;
            for (const id in seatsData) {
                const data = seatsData[id];
                if (data.state === 3 || data.name === 'X') continue;
                let targetTime = null; let periodIdx = -1;
                for(let p=0; p<9; p++) {
                    const key = `${dayIdx}-${p}`;
                    let scheduledTime = PERIODS[p].start;
                    if (data.scheduleGrid && data.scheduleGrid[key]) scheduledTime = data.scheduleGrid[key];
                    if (scheduledTime === time) { targetTime = scheduledTime; periodIdx = p; break; }
                }
                if (targetTime) {
                    const exemptKey = `${dayIdx}-${periodIdx}`;
                    const isExempt = data.exemptGrid && data.exemptGrid[exemptKey];
                    if (isExempt) { data.state = 4; } 
                    else { data.state = 0; triggerAlarm = true; }
                    data.penaltyInfo = null; changed = true;
                }
            }
            if (changed) { 
                saveData(); refreshVisuals(); updateSidebarList();
                if (triggerAlarm && !forceReset) playAlarm(); 
            }
        }
        function updateSidebarList() {
            const tbody = document.getElementById('status-tbody'); let html = '';
            const now = new Date(); const todayIdx = now.getDay();
            const currentHM = String(now.getHours()).padStart(2,'0') + ":" + String(now.getMinutes()).padStart(2,'0');
            for (const id in seatsData) {
                const data = seatsData[id]; const el = document.getElementById(id);
                if (el) el.classList.remove('flashing'); 
                if (data.state === 3 || data.state === 1 || data.state === 4 || data.name === 'X') continue;
                let latestMissedTime = null;
                for(let p=0; p<9; p++) {
                    const key = `${todayIdx}-${p}`;
                    const time = data.scheduleGrid && data.scheduleGrid[key] ? data.scheduleGrid[key] : PERIODS[p].start;
                    if (currentHM >= time) {
                        const isExempt = data.exemptGrid ? data.exemptGrid[key] : false;
                        if (!isExempt) { if (!latestMissedTime || time > latestMissedTime) latestMissedTime = time; }
                    }
                }
                if (latestMissedTime) {
                    const hasPenalty = data.penaltyInfo && data.penaltyInfo.type === 'penalty';
                    const isRecorded = data.penaltyInfo && data.penaltyInfo.recorded;
                    const isNoticed = data.penaltyInfo && data.penaltyInfo.noticed;
                    if (isRecorded && isNoticed) continue;
                    if (!hasPenalty && el) el.classList.add('flashing');
                    let statusHtml = `<span class="badge-late">ì§€ê°</span> <span style="font-size:11px; color:#888;">(${latestMissedTime})</span>`;
                    let actionHtml = `<button class="action-btn btn-attend" onclick="processAttend('${id}')">ì¶œì„</button><button class="action-btn btn-penalty" onclick="processPenalty('${id}')">ë²Œì </button>`;
                    let rowStyle = '';
                    if (hasPenalty) {
                        rowStyle = 'background-color: #fff5f5;';
                        let recordClass = isRecorded ? 'action-btn btn-check done' : 'action-btn btn-check';
                        let noticeClass = isNoticed ? 'action-btn btn-check done' : 'action-btn btn-check';
                        actionHtml = `<span class="badge-penalty-text">ë²Œì </span><button class="${recordClass}" onclick="toggleRecord('${id}')">ê¸°ë¡</button><button class="${noticeClass}" onclick="toggleNotice('${id}')">ê³ ì§€</button>`;
                    }
                    html += `<tr style="${rowStyle}"><td><b>${data.name}</b></td><td>${hasPenalty ? '-' : statusHtml}</td><td>${actionHtml}</td></tr>`;
                }
            }
            tbody.innerHTML = html === '' ? '<tr><td colspan="3" style="padding:20px; color:#999;">ì§€ê°ìƒì´ ì—†ìŠµë‹ˆë‹¤ ğŸ‰</td></tr>' : html;
        }

        function prepareForPrintOrSave() {
            // schedule-data-row í´ë˜ìŠ¤ë§Œ ìˆœíšŒ (ì ì‹¬/ì €ë… ì‹œê°„ ì œì™¸)
            const rows = document.querySelectorAll('.schedule-data-row');
            
            rows.forEach((row, r) => {
                const cells = row.cells;
                // ìº¡ì²˜ì‹œ êµì‹œ í…ìŠ¤íŠ¸ ì‚½ì… - ë°ì´í„°ì…‹ì—ì„œ ì´ë¦„ ê°€ì ¸ì˜´
                const pName = row.dataset.pname;
                const pTime = row.dataset.ptime;
                cells[0].innerText = `${pName}\n${pTime}`;
                
                for(let c=1; c<cells.length; c++) {
                    // cells[c]ëŠ” ì¼~í†  (index 1~7) + ì „ì²´ì´ˆê¸°í™”ë²„íŠ¼(8)
                    if(c > 7) { cells[c].style.display = 'none'; continue; } // ì´ˆê¸°í™” ì—´ ìˆ¨ê¹€

                    const cell = cells[c];
                    const input = cell.querySelector('input[type="time"]');
                    const memoInput = cell.querySelector('input.memo-input');
                    const btn = cell.querySelector('button');
                    const defaultTime = input.placeholder; // placeholderì— ê¸°ë³¸ì‹œê°„ ë“¤ì–´ìˆìŒ
                    
                    cell.className = ''; 
                    const spanText = document.createElement('span');
                    spanText.className = 'print-text-span';
                    const spanMemo = document.createElement('span');
                    spanMemo.className = 'print-memo-span';
                    
                    const memoVal = memoInput.value ? `(${memoInput.value})` : "";
                    
                    if (btn.dataset.exempt === 'true') {
                        cell.classList.add('cell-red');
                        spanText.textContent = "ì…ì‹¤ì•ˆí•¨";
                        spanText.style.color = "#fa5252"; // ì¸ì‡„ ì‹œ ë¹¨ê°•
                        spanText.style.fontWeight = "bold";
                    } else {
                        if (input.value && input.value !== defaultTime) {
                            cell.classList.add('cell-green-text');
                            spanText.textContent = input.value + " ì…ì‹¤";
                            spanMemo.textContent = memoVal;
                        } else {
                            cell.classList.add('cell-green');
                            spanText.textContent = ""; 
                            spanMemo.textContent = memoVal; 
                        }
                    }
                    input.style.display = 'none';
                    memoInput.style.display = 'none';
                    cell.appendChild(spanText);
                    cell.appendChild(spanMemo);
                }
            });
            document.body.classList.add('capture-mode');
            const modal = document.getElementById('schedule-modal');
            modal.style.width = "1200px";
        }

        function cleanupAfterPrintOrSave() {
            document.body.classList.remove('capture-mode');
            const spans = document.querySelectorAll('.print-text-span, .print-memo-span');
            spans.forEach(span => span.remove());
            const inputs = document.querySelectorAll('#schedule-tbody input');
            inputs.forEach(input => input.style.display = '');
            
            // ì´ˆê¸°í™” ì—´ ë‹¤ì‹œ ë³´ì´ê¸°
            const rows = document.querySelectorAll('.schedule-data-row');
            rows.forEach((row, r) => {
                // êµì‹œ í…ìŠ¤íŠ¸ ë³µêµ¬ (ì›ë˜ëŒ€ë¡œ HTML êµ¬ì¡°)
                const pName = row.dataset.pname;
                const pTime = row.dataset.ptime;
                row.cells[0].innerHTML = `<div style="display:flex; flex-direction:column; justify-content:center; height:100%;">
                                            <span style="font-size:16px;">${pName}</span>
                                            <span style="font-size:13px; color:#555; margin-top:4px;">${pTime}</span>
                                        </div>`;
                if(row.cells[8]) row.cells[8].style.display = '';
            });
            // ì ì‹¬/ì €ë… í–‰ì€ ê±´ë“œë¦¬ì§€ ì•Šì•„ë„ ë¨
            openScheduleModal(selectedSeatId);
        }

        function saveAsImage() {
            prepareForPrintOrSave();
            const modalContent = document.querySelector("#schedule-modal");
            html2canvas(modalContent, {
                scale: 2, useCORS: true, windowWidth: 1400, 
                backgroundColor: "#ffffff" // ë°°ê²½ìƒ‰ í°ìƒ‰ ê³ ì •
            }).then(canvas => {
                const link = document.createElement("a");
                document.body.appendChild(link);
                link.download = `ì‹œê°„í‘œ_${document.getElementById('info-name').value}.png`;
                link.href = canvas.toDataURL();
                link.target = '_blank';
                link.click();
                document.body.removeChild(link);
                cleanupAfterPrintOrSave();
            });
        }

        function printSchedule() {
            prepareForPrintOrSave();
            window.print();
            setTimeout(() => { cleanupAfterPrintOrSave(); }, 1000);
        }

        function applyPresetHighSchool() {
            if (!confirm("ê³ ë“±ë°˜ í”„ë¦¬ì…‹ì„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            applyPresetLogic((dayIdx, periodIdx) => (dayIdx >= 1 && dayIdx <= 5 && periodIdx <= 5));
        }
        function applyPresetNSu() {
            if (!confirm("Nìˆ˜/ì„±ì¸ë°˜ í”„ë¦¬ì…‹ì„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            applyPresetLogic((dayIdx, periodIdx) => (dayIdx === 0 && periodIdx >= 3) || (dayIdx >= 1 && periodIdx === 8));
        }
        function applyPresetLogic(isExemptFunc) {
            const rows = document.querySelectorAll('.schedule-data-row');
            rows.forEach((row) => {
                const periodIdx = parseInt(row.dataset.period);
                const cells = row.cells;
                for(let c=1; c<=7; c++) {
                    const dayIdx = c - 1;
                    const btn = cells[c].querySelector('button');
                    const input = cells[c].querySelector('input[type="time"]');
                    const defaultTime = PERIODS[periodIdx].start;
                    const shouldExempt = isExemptFunc(dayIdx, periodIdx);
                    if (shouldExempt) {
                        btn.classList.add('active'); btn.textContent = 'ì…ì‹¤ì•ˆí•¨ ë„ê¸°'; btn.dataset.exempt = 'true';
                        input.value = ''; updateColor(input, defaultTime); 
                    } else {
                        btn.classList.remove('active'); btn.textContent = 'ì…ì‹¤ì•ˆí•¨'; btn.dataset.exempt = 'false';
                        input.value = defaultTime; updateColor(input, defaultTime);
                    }
                }
            });
        }

        // ì „ì²´ ì…ì‹¤ì•ˆí•¨ ì„¤ì •
        function setAllExempt() {
            if(!confirm("ëª¨ë“  êµì‹œë¥¼ 'ì…ì‹¤ì•ˆí•¨'ìœ¼ë¡œ ì„¤ì •í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const rows = document.querySelectorAll('.schedule-data-row');
            rows.forEach((row) => {
                const periodIdx = parseInt(row.dataset.period);
                const cells = row.cells;
                for(let c=1; c<=7; c++) {
                    const btn = cells[c].querySelector('button');
                    const input = cells[c].querySelector('input[type="time"]');
                    const memo = cells[c].querySelector('input.memo-input');
                    const defaultTime = PERIODS[periodIdx].start;
                    
                    // ê°•ì œë¡œ ì…ì‹¤ì•ˆí•¨ ìƒíƒœë¡œ ë§Œë“¦
                    if (btn.dataset.exempt === 'false') {
                         btn.classList.add('active'); btn.textContent = 'ì…ì‹¤ì•ˆí•¨ ë„ê¸°'; btn.dataset.exempt = 'true';
                         input.value = ''; memo.value = ''; updateColor(input, defaultTime);
                    }
                }
            });
        }

        // --- ì´ˆê¸°í™” ê¸°ëŠ¥ (v19 & v20) ---
        function resetAllSchedule() {
            if(!confirm("ì¼ì£¼ì¼ì¹˜ ì‹œê°„í‘œë¥¼ ëª¨ë‘ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            const rows = document.querySelectorAll('.schedule-data-row');
            rows.forEach((row, r) => {
                const periodIdx = parseInt(row.dataset.period);
                const cells = row.cells;
                for(let c=1; c<=7; c++) {
                    const input = cells[c].querySelector('input[type="time"]');
                    const memo = cells[c].querySelector('input.memo-input');
                    const btn = cells[c].querySelector('button');
                    const defaultTime = PERIODS[periodIdx].start;
                    
                    input.value = ''; memo.value = '';
                    btn.classList.remove('active'); btn.textContent = 'ì…ì‹¤ì•ˆí•¨'; btn.dataset.exempt = 'false';
                    updateColor(input, defaultTime);
                }
            });
        }

        function resetDaySchedule(dayIdx) {
            if(!confirm(`${DAYS[dayIdx]}ìš”ì¼ ì‹œê°„í‘œë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const rows = document.querySelectorAll('.schedule-data-row');
            rows.forEach((row, r) => {
                const periodIdx = parseInt(row.dataset.period);
                const cell = row.cells[dayIdx + 1];
                const input = cell.querySelector('input[type="time"]');
                const memo = cell.querySelector('input.memo-input');
                const btn = cell.querySelector('button');
                const defaultTime = PERIODS[periodIdx].start;

                input.value = ''; memo.value = '';
                btn.classList.remove('active'); btn.textContent = 'ì…ì‹¤ì•ˆí•¨'; btn.dataset.exempt = 'false';
                updateColor(input, defaultTime);
            });
        }

        function resetPeriodSchedule(periodIdx) {
            if(!confirm(`${PERIODS[periodIdx].name} ì „ì²´ ìš”ì¼ì„ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) return;
            const rows = document.querySelectorAll(`.schedule-data-row[data-period="${periodIdx}"]`);
            if(rows.length > 0) {
                const row = rows[0];
                const cells = row.cells;
                for(let c=1; c<=7; c++) {
                    const input = cells[c].querySelector('input[type="time"]');
                    const memo = cells[c].querySelector('input.memo-input');
                    const btn = cells[c].querySelector('button');
                    const defaultTime = PERIODS[periodIdx].start;

                    input.value = ''; memo.value = '';
                    btn.classList.remove('active'); btn.textContent = 'ì…ì‹¤ì•ˆí•¨'; btn.dataset.exempt = 'false';
                    updateColor(input, defaultTime);
                }
            }
        }
        
        // ë¸”ë™ íƒ€ì„(ì ì‹¬/ì €ë…) í–‰ ìƒì„± í—¬í¼
        function createBreakRow(label, time) {
            const tr = document.createElement('tr');
            tr.className = 'break-row'; // CSS ìŠ¤íƒ€ì¼ ì ìš©ë¨ (ê²€ì€ìƒ‰ ë°°ê²½, í´ë¦­ ë¶ˆê°€)
            
            const tdLabel = document.createElement('td');
            tdLabel.innerHTML = `<span class="break-label">${label}</span><br><span class="break-sub">${time}</span>`;
            tr.appendChild(tdLabel);
            
            // ì¼~í†  + ì´ˆê¸°í™”ì—´ê¹Œì§€ 8ì¹¸ ë¹ˆì¹¸ ìƒì„±
            for(let i=0; i<8; i++) {
                const td = document.createElement('td');
                tr.appendChild(td);
            }
            return tr;
        }

        function openScheduleModal(id) {
            const data = seatsData[id]; const tbody = document.getElementById('schedule-tbody'); tbody.innerHTML = '';
            if(!data.scheduleGrid) data.scheduleGrid = {}; if(!data.exemptGrid) data.exemptGrid = {}; if(!data.memoGrid) data.memoGrid = {}; 

            document.getElementById('info-name').value = data.name === 'X' ? '' : data.name;
            document.getElementById('info-seat').value = data.name === 'X' ? id : data.name; 
            if(!data.info) data.info = { period: '', locker: '', phone: '' };
            document.getElementById('info-period').value = data.info.period;
            document.getElementById('info-locker').value = data.info.locker;
            document.getElementById('info-phone').value = data.info.phone;

            PERIODS.forEach((p, idx) => {
                // 3êµì‹œ í›„(idx=3ì¼ë•Œ ê·¸ ì•ì— ë„£ì§€ë§ê³ , idx=3 ë Œë”ë§ í›„ x -> idx=3(4êµì‹œ) ì§ì „ì— ë„£ì–´ì•¼í•¨)
                if(idx === 3) {
                    tbody.appendChild(createBreakRow("ì ì‹¬ì‹œê°„", "12:00~13:10"));
                }
                if(idx === 6) {
                    tbody.appendChild(createBreakRow("ì €ë…ì‹œê°„", "18:00~19:10"));
                }

                const tr = document.createElement('tr');
                tr.className = 'schedule-data-row'; // ë°ì´í„°ê°€ ìˆëŠ” ì‹¤ì œ êµì‹œ í–‰ ì‹ë³„ì
                tr.dataset.period = idx;
                tr.dataset.pname = p.name;
                tr.dataset.ptime = `${p.start} ~ ${p.end}`;

                const th = document.createElement('td'); 
                th.innerHTML = `<div style="display:flex; flex-direction:column; justify-content:center; height:100%;">
                                    <span style="font-size:16px;">${p.name}</span>
                                    <span style="font-size:13px; color:#555; margin-top:4px;">${p.start} ~ ${p.end}</span>
                                </div>`; 
                th.style.background = '#f1f3f5'; 
                tr.appendChild(th);
                for(let d=0; d<7; d++) {
                    const td = document.createElement('td'); const key = `${d}-${idx}`; 
                    
                    const input = document.createElement('input'); 
                    input.type = 'time'; 
                    input.step = 600; // [NEW] 10ë¶„ ë‹¨ìœ„ (600ì´ˆ)
                    input.dataset.day = d; input.dataset.period = idx;
                    
                    let val = data.scheduleGrid[key] || ""; input.value = val; input.placeholder = p.start;
                    if(val) updateColor(input, p.start);
                    
                    input.onfocus = function() { this.dataset.previous = this.value; };
                    input.onchange = function() {
                        const newVal = this.value; 
                        if (!newVal) { this.className = ''; return; }
                        
                        // [NEW] 10ë¶„ ë‹¨ìœ„ ê²€ì¦
                        const [h, m] = newVal.split(':');
                        if (parseInt(m) % 10 !== 0) {
                            alert("10ë¶„ ë‹¨ìœ„ë¡œë§Œ ì„¤ì •í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\n(ì˜ˆ: 10, 20, 30...)");
                            this.value = this.dataset.previous || "";
                            return;
                        }

                        if (newVal < p.start || newVal > p.end) { 
                            alert(`ì‹œê°„ ì˜¤ë¥˜\n(${p.name}: ${p.start} ~ ${p.end})`); 
                            this.value = this.dataset.previous; 
                            return; 
                        }
                        updateColor(this, p.start);
                    };
                    input.ondblclick = function(){ this.value = p.start; updateColor(this, p.start); };
                    
                    const memo = document.createElement('input'); 
                    memo.type = 'text'; memo.className = 'memo-input'; memo.placeholder = 'ë©”ëª¨';
                    memo.value = data.memoGrid[key] || "";

                    const btn = document.createElement('button'); const isExempt = data.exemptGrid[key]; 
                    btn.className = isExempt ? 'btn-toggle-exempt active' : 'btn-toggle-exempt';
                    btn.textContent = isExempt ? 'ì…ì‹¤ì•ˆí•¨ ë„ê¸°' : 'ì…ì‹¤ì•ˆí•¨';
                    btn.dataset.exempt = isExempt ? 'true' : 'false';
                    btn.onclick = function() {
                        if (this.classList.contains('active')) { 
                            this.classList.remove('active'); this.textContent = 'ì…ì‹¤ì•ˆí•¨'; this.dataset.exempt = 'false'; 
                            input.value = p.start; updateColor(input, p.start); // ë©´ì œ í•´ì œì‹œ ê¸°ë³¸ê°’
                        } else { 
                            this.classList.add('active'); this.textContent = 'ì…ì‹¤ì•ˆí•¨ ë„ê¸°'; this.dataset.exempt = 'true'; 
                            input.value = ''; memo.value = ''; updateColor(input, p.start); // ë©´ì œ ì‹œ ì´ˆê¸°í™”
                        }
                    };
                    
                    td.appendChild(input); 
                    td.appendChild(memo); 
                    td.appendChild(btn); 
                    tr.appendChild(td);
                }
                
                // êµì‹œë³„ ì´ˆê¸°í™” ë²„íŠ¼ ì…€
                const tdReset = document.createElement('td');
                const btnReset = document.createElement('button');
                btnReset.className = 'btn-row-reset';
                btnReset.textContent = 'ì´ˆê¸°í™”';
                btnReset.onclick = function() { resetPeriodSchedule(idx); };
                tdReset.appendChild(btnReset);
                tr.appendChild(tdReset);

                tbody.appendChild(tr);
            });
            document.getElementById('modal-overlay').style.display = 'block'; document.getElementById('schedule-modal').style.display = 'block';
        }

        function saveSchedule() {
            const data = seatsData[selectedSeatId]; 
            data.scheduleGrid = {}; data.scheduleV3 = {}; data.exemptGrid = {}; data.memoGrid = {};
            
            const newName = document.getElementById('info-name').value;
            if (newName && newName.trim() !== '') data.name = newName;
            data.info = {
                period: document.getElementById('info-period').value,
                locker: document.getElementById('info-locker').value,
                phone: document.getElementById('info-phone').value
            };

            const rows = document.querySelectorAll('.schedule-data-row');
            rows.forEach((row) => {
                const periodIdx = parseInt(row.dataset.period);
                const cells = row.cells;
                for(let c=1; c<=7; c++) { // 1~7 are days
                    const dayIdx = c - 1; const cell = cells[c];
                    const input = cell.querySelector('input[type="time"]');
                    const memo = cell.querySelector('input.memo-input');
                    const btn = cell.querySelector('button');
                    
                    const key = `${dayIdx}-${periodIdx}`;
                    if(input.value) { data.scheduleGrid[key] = input.value; }
                    if(memo.value) { data.memoGrid[key] = memo.value; }
                    if (btn.dataset.exempt === 'true') { data.exemptGrid[key] = true; }
                }
            });
            saveData(); refreshVisuals(); updateSidebarList(); closeModal();
        }

        function updateColor(el, std) { el.className = ''; if(!el.value) return; if(el.value === std) el.classList.add('input-basic'); else el.classList.add('input-custom'); }
        function closeModal() { document.getElementById('modal-overlay').style.display = 'none'; document.getElementById('schedule-modal').style.display = 'none'; }
        function resetGreenSeats() {
            if (!confirm('ì¶œì„(ì´ˆë¡) ì¢Œì„ì„ ëª¨ë‘ í‡´ì‹¤ ì²˜ë¦¬í•©ë‹ˆê¹Œ?')) return;
            for (const id in seatsData) { if (seatsData[id].state === 1) seatsData[id].state = 0; }
            saveData(); refreshVisuals(); updateSidebarList();
        }
        function downloadBackup() {
            const dataStr = JSON.stringify(seatsData, null, 2); const blob = new Blob([dataStr], { type: "text/plain" });
            const url = URL.createObjectURL(blob); const a = document.createElement('a'); const date = new Date().toISOString().slice(0,10); 
            a.href = url; a.download = `í•©ê²©ë©_ë°ì´í„°ë°±ì—…_${date}.txt`; document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
            alert("ë°ì´í„°ê°€ 'ë©”ëª¨ì¥ íŒŒì¼(.txt)'ë¡œ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\në”ë¸” í´ë¦­í•´ì„œ ë‚´ìš©ì„ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.");
        }
        function triggerRestore() { document.getElementById('file-input').click(); }
        function loadBackup(input) {
            const file = input.files[0]; if (!file) return; const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const loadedData = JSON.parse(e.target.result);
                    if (confirm("ë°±ì—… ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ?\ní˜„ì¬ ë°ì´í„°ëŠ” ë®ì–´ì”Œì›Œì§‘ë‹ˆë‹¤.")) {
                        seatsData = loadedData; migrateData();
                        saveData(); refreshVisuals(); updateSidebarList(); alert("ë°ì´í„° ë³µêµ¬ê°€ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!");
                    }
                } catch (err) { alert("ì˜ëª»ëœ íŒŒì¼ì´ê±°ë‚˜ ì†ìƒëœ ë°ì´í„°ì…ë‹ˆë‹¤.\nì˜¬ë°”ë¥¸ ë°±ì—… íŒŒì¼(.txt)ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”."); }
                input.value = ''; 
            };
            reader.readAsText(file);
        }
        function showSeatMenu(e, id) { e.preventDefault(); selectedSeatId = id; const menu = document.getElementById('seat-context-menu'); menu.style.display = 'block'; menu.style.left = e.pageX + 'px'; menu.style.top = e.pageY + 'px'; }
        function seatMenuAction(action) {
            const data = seatsData[selectedSeatId];
            if (action === 'editName') { const newName = prompt('ì´ë¦„ ë³€ê²½:', data.name); if (newName) data.name = newName; }
            else if (action === 'toggleBlack') { data.state = (data.state === 3) ? 0 : 3; }
            else if (action === 'schedule') { openScheduleModal(selectedSeatId); }
            saveData(); refreshVisuals(); updateSidebarList();
        }
        function processAttend(id) { const data = seatsData[id]; data.state = 1; data.penaltyInfo = null; saveData(); refreshVisuals(); updateSidebarList(); }
        function processPenalty(id) { const data = seatsData[id]; data.penaltyInfo = { type: 'penalty', recorded: false, noticed: false }; saveData(); refreshVisuals(); updateSidebarList(); }
        function toggleRecord(id) { const data = seatsData[id]; if(data.penaltyInfo) { data.penaltyInfo.recorded = !data.penaltyInfo.recorded; saveData(); updateSidebarList(); } }
        function toggleNotice(id) { const data = seatsData[id]; if(data.penaltyInfo) { data.penaltyInfo.noticed = !data.penaltyInfo.noticed; saveData(); updateSidebarList(); } }
    </script>
</body>
</html>
